<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Killer Pool</title>

<style>
:root{
  --bg1:#6ff0c0;
  --bg2:#29b98b;
  --panel:rgba(255,255,255,.18);
  --border:rgba(255,255,255,.28);
}
*{box-sizing:border-box;}

body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  font-family:system-ui,Segoe UI,Roboto,Arial;
  color:#fff;
  padding:18px 10px 26px;
}

.frame{width:min(740px,100%);text-align:center;position:relative;}

h1{
  font-weight:1000;
  margin:10px 0 14px;
  text-shadow:0 10px 30px rgba(0,0,0,.28);
}

.rail{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:0 12px 30px rgba(0,0,0,.22);
}

input,button{
  width:92%;
  max-width:360px;
  padding:12px 14px;
  margin:7px 0;
  border-radius:14px;
  border:none;
  font-size:18px;
}

input{
  background:rgba(255,255,255,.25);
  color:#fff;
  text-align:center;
  outline:none;
}
input::placeholder{ color: rgba(255,255,255,.85); }

button{
  font-weight:900;
  cursor:pointer;
  letter-spacing:.2px;
  transform: translateY(0);
  transition: transform .08s ease, filter .15s ease;
}
button:active{ transform: translateY(1px) scale(.99); }
button:hover{ filter: brightness(1.06); }

.secondary{background:#3498db;color:#fff;}
.play{background:#2ecc71;color:#111;}
.miss{background:#e67e22;color:#111;}
.pot{background:#1abc9c;color:#111;}
.black{background:#000;color:#fff;}
.whiteball{background:#fff;color:#111;}

.topButtons{
  position:fixed;
  top:10px;
  right:10px;
  display:flex;
  gap:8px;
  z-index:2000;
}
.smallBtn{
  width:auto; max-width:none;
  padding:8px 12px;
  margin:0;
  font-size:14px;
  border-radius:999px;
  background:rgba(0,0,0,.33);
  color:#fff;
  border:1px solid rgba(255,255,255,.18);
}

.stage{margin-top:10px;}

.nameBig{
  font-size:clamp(34px,7vw,56px);
  font-weight:1000;
  margin:10px 0 8px;
  text-shadow:0 14px 40px rgba(0,0,0,.35);
}

.cardBox{
  background:#fff;
  color:#111;
  border-radius:18px;
  padding:18px;
  font-size:84px;
  font-weight:1000;
  width:240px;
  margin:10px auto 14px;
  box-shadow:0 14px 35px rgba(0,0,0,.22);
}

.btnRow{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}
.btnRow button{ width:min(210px,46%); }

.piles{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
  margin-top:14px;
}
@media(min-width:640px){
  .piles{grid-template-columns:1fr 1fr 1fr;}
}
.pile{
  background:rgba(255,255,255,.14);
  border:1px solid rgba(255,255,255,.22);
  border-radius:16px;
  padding:12px;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
}
.pile h3{
  margin:0 0 6px;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:.6px;
  opacity:.95;
}
.count{
  font-size:34px;
  font-weight:1000;
}

.muted{
  opacity:.9;
  font-weight:800;
  margin-top:10px;
}

/* Dramatic reshuffle overlay */
#reshuffleOverlay{
  display:none;
  position:fixed;
  inset:0;
  z-index:5000;
  background:radial-gradient(900px 520px at 50% 35%, rgba(255,255,255,.22), rgba(0,0,0,.85));
  place-items:center;
  pointer-events:none;
}
#reshuffleInner{
  display:grid;
  place-items:center;
  gap:18px;
}
#reshuffleText{
  font-size:clamp(46px,9vw,96px);
  font-weight:1000;
  letter-spacing:2px;
  text-transform:uppercase;
  text-shadow:0 18px 60px rgba(0,0,0,.7);
  opacity:0;
  transform:scale(.85);
  animation:reshPop 1.35s cubic-bezier(.2,.9,.2,1) forwards;
}
@keyframes reshPop{
  0%{opacity:0;transform:scale(.82);filter:blur(1px);}
  25%{opacity:1;transform:scale(1.06);filter:blur(0);}
  70%{opacity:1;transform:scale(1.00);}
  100%{opacity:0;transform:scale(1.10);}
}
.cardPile{
  position:relative;
  width:170px;
  height:220px;
  transform:translateY(6px);
  filter:drop-shadow(0 18px 40px rgba(0,0,0,.6));
}
.cardSheet{
  position:absolute;
  inset:0;
  border-radius:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(230,230,230,.95));
  border:1px solid rgba(255,255,255,.65);
}
.cardSheet:nth-child(1){ transform:rotate(-8deg) translate(-10px, 10px); opacity:.92;}
.cardSheet:nth-child(2){ transform:rotate(7deg) translate(12px, 16px); opacity:.90;}
.cardSheet:nth-child(3){ transform:rotate(-2deg) translate(5px, 3px); opacity:1;}
.cardStamp{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  font-size:64px;
  opacity:.9;
}

/* Ref overlay */
#refOverlay{
  display:none;
  position:fixed;
  inset:0;
  z-index:4500;
  background:rgba(0,0,0,.86);
  padding:18px;
  overflow:auto;
}
#refPanel{
  width:min(720px,100%);
  margin:0 auto;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.18);
  border-radius:18px;
  padding:14px 14px 18px;
  box-shadow:0 14px 40px rgba(0,0,0,.35);
}
#refPanel h2{margin:6px 0 10px;}
#refPanel .line{line-height:1.65;font-size:18px;}
.refPill{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.16);
  margin-left:8px;
  font-size:14px;
  opacity:.95;
}
</style>
</head>

<body>
<div class="topButtons">
  <button class="smallBtn" onclick="toggleRef()">üßë‚Äç‚öñÔ∏è Ref</button>
  <button class="smallBtn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
</div>

<div class="frame">
  <h1>üé± Killer Pool</h1>

  <div class="rail">
    <!-- SETUP -->
    <div id="setup">
      <div id="playerList"></div>
      <button class="secondary" onclick="addPlayer()">‚ûï Add Player</button>
      <button onclick="drawCards()">üé¥ Draw Cards</button>
      <div id="results"></div>
      <button id="startBtn" class="play" onclick="startGame()" style="display:none;">‚ñ∂Ô∏è Play Game</button>
    </div>

    <!-- GAME -->
    <div id="game" class="stage" style="display:none;">
      <div class="nameBig" id="currentName"></div>
      <div class="cardBox" id="cardBox">A</div>

      <div class="btnRow">
        <button class="miss" onclick="doAction('miss')">‚ùå Miss</button>
        <button class="pot" onclick="doAction('pot')">üéØ Pot</button>
        <button class="black" onclick="doAction('black')">‚ö´ Black</button>
        <button class="whiteball" onclick="doAction('white')">‚ö™ White</button>
      </div>

      <div class="piles">
        <div class="pile">
          <h3>Pile 1 ‚Äî In Play (on players)</h3>
          <div class="count" id="p1">0</div>
        </div>
        <div class="pile">
          <h3>Pile 2 ‚Äî Banked (safe)</h3>
          <div class="count" id="p2">0</div>
        </div>
        <div class="pile">
          <h3>Pile 3 ‚Äî Dead</h3>
          <div class="count" id="p3">0</div>
        </div>
      </div>

      <div class="muted">
        Piles are secret (counts only). Pot/Black moves 1 life from P1 ‚Üí P2. Reshuffle when P1 hits 0.
      </div>
    </div>
  </div>
</div>

<!-- Dramatic reshuffle -->
<div id="reshuffleOverlay">
  <div id="reshuffleInner">
    <div id="reshuffleText">RESHUFFLE</div>
    <div class="cardPile" aria-hidden="true">
      <div class="cardSheet"></div>
      <div class="cardSheet"></div>
      <div class="cardSheet"></div>
      <div class="cardStamp">üé¥</div>
    </div>
  </div>
</div>

<!-- Ref overlay -->
<div id="refOverlay" onclick="toggleRef()">
  <div id="refPanel" onclick="event.stopPropagation()">
    <h2>üßë‚Äç‚öñÔ∏è Referee Mode</h2>
    <div id="refContent" class="line"></div>
    <button class="smallBtn" style="margin-top:12px;" onclick="toggleRef()">Close</button>
  </div>
</div>

<script>
const baseDeck = ["A","K","Q","J","10","9","8","7","6","5","4","3","2"];

let players = [];        // { name, card, inPlay, banked }
let activePlayers = [];  // indices of players still alive (inPlay+banked > 0)
let currentIdx = null;

let pileDead = 0;

function shuffle(arr){
  const a = [...arr];
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function addPlayer(){
  const count = document.querySelectorAll("#playerList input").length;
  if (count >= 13) return alert("Maximum 13 players (A‚Äì2).");
  const input = document.createElement("input");
  input.placeholder = "Player name";
  document.getElementById("playerList").appendChild(input);
}

function drawCards(){
  const names = [...document.querySelectorAll("#playerList input")]
    .map(i=>i.value.trim())
    .filter(Boolean);

  if (!names.length) return alert("Enter at least 1 player.");

  const deck = shuffle([...baseDeck]);

  players = names.map(n => ({
    name: n,
    card: deck.pop(),  // assigned card never changes
    inPlay: 3,         // Pile 1 lives
    banked: 0          // Pile 2 lives
  }));

  activePlayers = [];
  currentIdx = null;
  pileDead = 0;

  const results = document.getElementById("results");
  results.innerHTML =
    "<div style='font-weight:1000; margin:10px 0 6px;'>Dealt:</div>" +
    players.map(p => `<div>${escapeHtml(p.name)} ‚Äî <strong>${escapeHtml(p.card)}</strong></div>`).join("");

  document.getElementById("startBtn").style.display = "inline-block";
  updatePilesUI();
}

function startGame(){
  if (!players.length) return;
  activePlayers = players.map((_,i)=>i);
  document.getElementById("setup").style.display = "none";
  document.getElementById("game").style.display = "block";
  nextTurn();
}

function totalPile1(){
  return players.reduce((sum,p)=>sum + Math.max(0,p.inPlay), 0);
}
function totalPile2(){
  return players.reduce((sum,p)=>sum + Math.max(0,p.banked), 0);
}

function updatePilesUI(){
  document.getElementById("p1").textContent = totalPile1();
  document.getElementById("p2").textContent = totalPile2();
  document.getElementById("p3").textContent = pileDead;
}

function showReshuffle(){
  const o = document.getElementById("reshuffleOverlay");
  o.style.display = "grid";
  const t = document.getElementById("reshuffleText");
  t.style.animation = "none";
  void t.offsetWidth;
  t.style.animation = "";
  setTimeout(()=>{ o.style.display = "none"; }, 1400);
}

// When Pile 1 is empty, move ALL banked -> in play (global reshuffle)
function reshuffleIfNeeded(){
  if (totalPile1() === 0 && totalPile2() > 0){
    showReshuffle();
    players.forEach(p=>{
      p.inPlay += p.banked;
      p.banked = 0;
    });
  }
}

function pickShooterIndex(){
  // Only players with inPlay > 0 can be picked as "in play"
  const candidates = activePlayers.filter(i => players[i].inPlay > 0);
  if (candidates.length === 0) return null;
  return candidates[Math.floor(Math.random()*candidates.length)];
}

function nextTurn(){
  // remove anyone fully dead from activePlayers (safety)
  activePlayers = activePlayers.filter(i => (players[i].inPlay + players[i].banked) > 0);

  // win condition: only one person has any lives (inplay+banked)
  if (activePlayers.length === 1){
    const w = players[activePlayers[0]];
    document.getElementById("currentName").textContent = `üèÜ ${w.name} WINS`;
    document.getElementById("cardBox").textContent = w.card;
    updatePilesUI();
    return;
  }
  if (activePlayers.length === 0){
    document.getElementById("currentName").textContent = "Game Over";
    document.getElementById("cardBox").textContent = "‚Äî";
    updatePilesUI();
    return;
  }

  // if nobody is in play right now, reshuffle (if possible) then try again
  if (totalPile1() === 0){
    reshuffleIfNeeded();
  }

  const idx = pickShooterIndex();
  if (idx === null){
    // still nobody in play (means no banked either) => end
    document.getElementById("currentName").textContent = "Game Over";
    document.getElementById("cardBox").textContent = "‚Äî";
    updatePilesUI();
    return;
  }

  currentIdx = idx;
  const p = players[currentIdx];
  document.getElementById("currentName").textContent = p.name;
  document.getElementById("cardBox").textContent = p.card;
  updatePilesUI();
}

/*
RULES (this is the key fix):
- POT / BLACK: move 1 life from THIS PLAYER‚ÄôS inPlay -> banked  (Pile 1 -> Pile 2)
- MISS / WHITE: move 1 life from THIS PLAYER‚ÄôS inPlay -> dead     (Pile 1 -> Pile 3)
- Reshuffle only when TOTAL pile 1 is 0.
*/
function doAction(type){
  if (currentIdx === null) return;
  const p = players[currentIdx];

  if (type === "pot" || type === "black"){
    // if P1 empty globally, reshuffle first (so players can bank again later)
    if (totalPile1() === 0) reshuffleIfNeeded();

    // Move one of THIS PLAYER'S in-play lives to banked
    if (p.inPlay > 0){
      p.inPlay -= 1;  // ‚úÖ this is why you‚Äôll SEE P1 drop
      p.banked += 1;  // ‚úÖ and P2 rise
    }
    updatePilesUI();
    nextTurn();
    return;
  }

  if (type === "miss" || type === "white"){
    if (p.inPlay > 0){
      p.inPlay -= 1;
      pileDead += 1;
    }

    // if player has no inPlay and no banked, they‚Äôre out
    if ((p.inPlay + p.banked) <= 0){
      activePlayers = activePlayers.filter(i => i !== currentIdx);
    }

    // if after losing, P1 becomes empty, reshuffle before next shooter
    if (totalPile1() === 0) reshuffleIfNeeded();

    updatePilesUI();
    nextTurn();
    return;
  }
}

function toggleRef(){
  const overlay = document.getElementById("refOverlay");
  const open = overlay.style.display !== "block";
  if (!open){
    overlay.style.display = "none";
    return;
  }

  const lines = [];
  lines.push(`<div><strong>Piles:</strong>
    <span class="refPill">P1 In Play: ${totalPile1()}</span>
    <span class="refPill">P2 Banked: ${totalPile2()}</span>
    <span class="refPill">P3 Dead: ${pileDead}</span>
  </div><br>`);

  lines.push("<div><strong>Players:</strong></div>");
  players.forEach((pl,i)=>{
    const status = activePlayers.includes(i) ? "IN" : "OUT";
    const shooter = (i===currentIdx && status==="IN") ? " ‚Äî SHOOTER" : "";
    lines.push(
      `${escapeHtml(pl.name)} ‚Äî ${escapeHtml(pl.card)} ‚Äî ` +
      `InPlay: ${pl.inPlay}, Banked: ${pl.banked}` +
      ` <span class="refPill">${status}${shooter}</span>`
    );
  });

  document.getElementById("refContent").innerHTML = lines.join("<br>");
  overlay.style.display = "block";
}

function toggleFullscreen(){
  const el = document.documentElement;
  if (!document.fullscreenElement){
    if (el.requestFullscreen) el.requestFullscreen();
  } else {
    if (document.exitFullscreen) document.exitFullscreen();
  }
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// start with 2 inputs
addPlayer();
addPlayer();
</script>
</body>
</html>
